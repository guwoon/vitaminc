<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>실시간 다국어 자막</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            height: 100vh;
        }
        .language-section {
            border: 1px solid #ccc;
            box-sizing: border-box;
            overflow: hidden;
        }
        .language-title {
            font-size: 3em; /* 폰트 크기를 2배로 증가 */
            font-weight: bold;
            text-align: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 10px;
        }
        .translations {
            padding: 10px;
            height: calc(100% - 80px);
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse; /* 역순으로 표시 */
            justify-content: flex-start;
        }
        .translation {
            font-size: 3em; /* 폰트 크기를 2배로 증가 */
            margin-bottom: 10px;
        }
        .translation.newest {
            font-weight: bold;
        }
        #original {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 1;
        }
        button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            font-size: 1em;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="original">원본 텍스트: </div>
    <button onclick="startRecognition()">음성 인식 시작</button>
    <div class="container" id="translations-container">
        <!-- 언어별 섹션이 여기에 추가됩니다 -->
    </div>

    <script>
        let recognition;
        let languages = {
            'ko': '한국어',
            'en': '영어',
            'fr': '프랑스어',
            'zh-CN': '중국어(간체)',
            'id': '인도네시아어',
            'mn': '몽골어'
        };

        function startRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('이 브라우저는 음성 인식을 지원하지 않습니다.');
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR'; // 인식 언어: 한국어
            recognition.continuous = true;
            recognition.interimResults = true; // 중간 결과 받기

            recognition.onresult = function(event) {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    transcript += event.results[i][0].transcript;
                }
                transcript = transcript.trim();
                document.getElementById('original').innerText = '원본 텍스트: ' + transcript;
                translateText(transcript);
            };

            recognition.onerror = function(event) {
                console.error('음성 인식 오류:', event.error);
            };

            recognition.start();
        }

        let translationQueue = [];

        function translateText(text) {
            translationQueue.push(text);

            if (translationQueue.length === 1) {
                processTranslationQueue();
            }
        }

        async function processTranslationQueue() {
            while (translationQueue.length > 0) {
                let text = translationQueue[0];

                let promises = [];
                for (let [langCode, langName] of Object.entries(languages)) {
                    promises.push(translateSingleText(text, langCode, langName));
                }

                await Promise.all(promises);

                translationQueue.shift();
            }
        }

        async function translateSingleText(text, langCode, langName) {
            try {
                let translatedText;
                if (langCode === 'ko') {
                    // 원어인 한국어는 번역하지 않고 그대로 표시
                    translatedText = text;
                } else {
                    let response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=ko|${langCode}`);
                    let data = await response.json();
                    translatedText = data.responseData.translatedText;
                }
                appendTranslation(langName, translatedText);
            } catch (error) {
                console.error('번역 오류:', error);
            }
        }

        function appendTranslation(langName, translatedText) {
            let container = document.getElementById('translations-container');
            let languageSection = document.getElementById(`lang-${langName}`);

            if (!languageSection) {
                // 언어 섹션 생성
                languageSection = document.createElement('div');
                languageSection.className = 'language-section';
                languageSection.id = `lang-${langName}`;

                let title = document.createElement('div');
                title.className = 'language-title';
                title.innerText = langName;

                let translationsDiv = document.createElement('div');
                translationsDiv.className = 'translations';
                translationsDiv.id = `translations-${langName}`;

                languageSection.appendChild(title);
                languageSection.appendChild(translationsDiv);
                container.appendChild(languageSection);
            }

            let translationsDiv = document.getElementById(`translations-${langName}`);

            // 새로운 번역 추가 (최신 항목이 상단에 오도록)
            let p = document.createElement('div');
            p.className = 'translation newest';
            p.innerText = translatedText;

            // 이전에 'newest' 클래스를 가진 요소의 클래스를 제거
            let previousNewest = translationsDiv.querySelector('.translation.newest');
            if (previousNewest) {
                previousNewest.classList.remove('newest');
            }

            translationsDiv.insertBefore(p, translationsDiv.firstChild);

            // 최대 표시 줄 수 제한 (예: 3줄)
            while (translationsDiv.childElementCount > 3) {
                translationsDiv.removeChild(translationsDiv.lastChild);
            }
        }
    </script>
</body>
</html>
